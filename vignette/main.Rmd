---
title: "Semantic Associate Retrieval Practice"
subtitle: "Pilot 2"
author: "William Hopper"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, fig.align = "center", fig.width = 9)
library(dplyr)
library(stringdist)
library(tibble)
library(ggplot2)
library(tidyr)
library(pander)
source("R/test_tidying.R")
```

```{r reading}
oldwd <- setwd("data-raw")

# Lists/condition assignment table
conditions <-  read.csv("lists.csv", stringsAsFactors = FALSE) %>%
  rename(practice_cue_type = cue_type) %>%
  mutate(practice_cue_type = replace(practice_cue_type,
                                     which(practice == "N"),
                                     NA_character_))

## Group assignment table
subjects <- read.csv("participants.csv", stringsAsFactors = FALSE)

column_types <- c("integer","integer","integer", "integer", "integer",
                  "character", "character", "numeric", "integer", "numeric",
                  "numeric", "numeric", "numeric", "character")
# Test Practice
test_practice_raw <- read.csv("test_practice.csv", stringsAsFactors = FALSE, na.strings = "",
                              colClasses = column_types) %>%
  mutate(recalled = as.logical(recalled))

# Final Test
final_test_raw <- read.csv("final_test.csv", stringsAsFactors = FALSE, na.strings = "",
                           colClasses = column_types) %>%
  mutate(recalled = as.logical(recalled))

setwd(oldwd)

rm(column_types)
```

```{r tidying}
join_variables <- c("subject", "id", "list")
select_variables <- c(join_variables, "practice", "practice_cue_type")

# Remove subjects with technical problems from the dataset.
subjects <- filter(subjects, subject >= 1)

## Practice Test
test_practice_raw <- test_practice_raw %>%
  inner_join(x = .,
             y = subjects[c("subject","group")],
             by = "subject") %>%
  left_join(x = .,
            y = conditions[select_variables],
            by = join_variables) %>%
  test_tidying()

# Check these fuzzy matches by hand
tp_fuzzy <- filter(tibble::rownames_to_column(test_practice_raw, "row"),
                   !hard_match & fuzzy_match) %>%
   select(row, subject, cue, target, response)


# Final Test
final_test_raw <- final_test_raw %>%
  inner_join(x = .,
             y = subjects[c("subject","group")],
             by = "subject") %>%
  left_join(x = .,
            y = conditions[select_variables],
            by = join_variables) %>%
  test_tidying()

# Check these fuzzy matches by hand
final_fuzzy <- filter(tibble::rownames_to_column(final_test_raw, "row"),
                      !hard_match & fuzzy_match) %>%
   select(row, subject, cue, target, response)

# These are determined by manual inspection
final_test_raw[final_test_raw$subject == 21 & final_test_raw$cue == "comedy",
               'fuzzy_match'] <- FALSE

## Combine practice and final tests into one data frame
tests_raw <- bind_rows(`1`=test_practice_raw, `2`=final_test_raw,
                       .id = "test") %>%
  rename(correct = fuzzy_match) %>%
  mutate(logRT = log(RT),
         test = as.numeric(test)) %>%
  select(subject, group, test, list, trial, practice, practice_cue_type, decided, recalled,
         correct, RT, logRT, pre_typing_lag:post_typing_lag) %>%
  arrange(subject, test, list)

# Remove trials where a remember/don't remember decision was not reached, and trial timed out.
tests_raw <- filter(tests_raw, decided)

rm(tp_fuzzy, final_fuzzy, join_variables, select_variables)
```

```{r aggregating_by_subject}
#### Aggregate reaction time measures for each subject in each condition
RT_by_subject <- tests_raw %>%
  group_by(subject, group, test, practice, practice_cue_type, correct) %>%
  filter(!is.na(RT)) %>%
  summarise(N_RT_trials = n(),
            mean_RT = mean(RT),
            mean_logRT = mean(logRT),
            median_RT = median(RT)) %>%
  ungroup()

#### Calculate accuracy for each subject in each condition
acc_by_subject <- tests_raw %>%
  group_by(subject, group, test, practice, practice_cue_type) %>%
  summarise(N_acc_trials = n(),
            N_correct = sum(correct),
            percent_correct = N_correct/N_acc_trials) %>%
  ungroup()

#### Calculate the RT difference from baseline on final test
tmp <- RT_by_subject %>%
  filter(test == 2) %>%
  select(-test, -N_RT_trials) %>%
  gather(key="var", value="value", mean_RT, median_RT, mean_logRT) %>%
  unite(var, practice, var, sep=".") %>%
  spread(var, value)

control <- filter(tmp, is.na(practice_cue_type)) %>%
  select(subject, correct, starts_with("N"))
treatment <- filter(tmp, !is.na(practice_cue_type))%>%
  select(-starts_with("N"))

RT_diff_by_subject <- left_join(treatment, control, 
                                by=c("subject", "correct")) %>%
  mutate(SN.median_RT = S.median_RT - N.median_RT,
         TN.median_RT = T.median_RT - N.median_RT,
         SN.mean_logRT = S.mean_logRT - N.mean_logRT,
         TN.mean_logRT = T.mean_logRT - N.mean_logRT,
         SN.mean_RT = S.mean_RT - N.mean_RT,
         TN.mean_RT = T.mean_RT - N.mean_RT) %>%
  select(subject, group, practice_cue_type, correct,
         SN.median_RT, TN.median_RT,
         SN.mean_logRT, TN.mean_logRT,
         SN.mean_RT, TN.mean_RT) %>%
  gather(key="var", value="value", -(subject:correct)) %>%
  separate(var, into = c("practice", "var"),sep = "\\.") %>%
  spread(var,value) %>%
  mutate(practice = paste(substr(practice, 1, 1),
                          substr(practice, 2, 2),
                          sep = "-"))


#### Calculate the accuracy difference from baseline on final test
tmp <- acc_by_subject %>%
  filter(test == 2) %>%
  select(subject:practice_cue_type, percent_correct, -test) %>%
  gather(key="var", value="value", percent_correct) %>%
  unite(var, practice, var, sep=".") %>%
  spread(var, value)

control <- filter(tmp, is.na(practice_cue_type)) %>%
  select(subject, starts_with("N"))
treatment <- filter(tmp, !is.na(practice_cue_type))%>%
  select(-starts_with("N"))

acc_diff_by_subject <- left_join(treatment, control, 
                                by=c("subject")) %>%
  mutate(SN.percent_correct = S.percent_correct - N.percent_correct,
         TN.percent_correct = T.percent_correct - N.percent_correct) %>%
  select(subject, group, practice_cue_type, SN.percent_correct, TN.percent_correct) %>%
  gather(key="var", value="value", SN.percent_correct, TN.percent_correct) %>%
  separate(var, into = c("practice", "var"),sep = "\\.") %>%
  spread(var,value) %>%
  mutate(practice = paste(substr(practice, 1, 1),
                          substr(practice, 2, 2),
                          sep = "-"))
```