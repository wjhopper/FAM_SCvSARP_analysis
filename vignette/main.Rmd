---
title: "Semantic Associate Retrieval Practice"
subtitle: "Pilot 2"
author: "William Hopper"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, fig.align = "center", fig.width = 9)
library(dplyr)
library(stringdist)
library(tibble)
library(ggplot2)
library(tidyr)
library(pander)
source("R/test_tidying.R")
```

```{r reading}
oldwd <- setwd("data-raw")

# Lists/condition assignment table
conditions <-  read.csv("lists.csv", stringsAsFactors = FALSE) %>%
  rename(practice_cue_type = cue_type) %>%
  mutate(practice_cue_type = replace(practice_cue_type,
                                     which(practice == "N"),
                                     NA_character_))

## Group assignment table
subjects <- read.csv("participants.csv", stringsAsFactors = FALSE)

column_types <- c("integer","integer","integer", "integer", "integer",
                  "character", "character", "numeric", "integer", "numeric",
                  "numeric", "numeric", "numeric", "character")
# Test Practice
test_practice_raw <- read.csv("test_practice.csv", stringsAsFactors = FALSE, na.strings = "",
                              colClasses = column_types) %>%
  mutate(recalled = as.logical(recalled))

# Final Test
final_test_raw <- read.csv("final_test.csv", stringsAsFactors = FALSE, na.strings = "",
                           colClasses = column_types) %>%
  mutate(recalled = as.logical(recalled))

setwd(oldwd)

rm(column_types)
```

```{r tidying}
join_variables <- c("subject", "id", "list")
select_variables <- c(join_variables, "practice", "practice_cue_type")

# Remove subjects with technical problems from the dataset.
subjects <- filter(subjects, subject >= 1)

## Practice Test
test_practice_raw <- test_practice_raw %>%
  inner_join(x = .,
             y = subjects[c("subject","group")],
             by = "subject") %>%
  left_join(x = .,
            y = conditions[select_variables],
            by = join_variables) %>%
  test_tidying()

# Check these fuzzy matches by hand
tp_fuzzy <- filter(tibble::rownames_to_column(test_practice_raw, "row"),
                   !hard_match & fuzzy_match) %>%
   select(row, subject, cue, target, response)


# Final Test
final_test_raw <- final_test_raw %>%
  inner_join(x = .,
             y = subjects[c("subject","group")],
             by = "subject") %>%
  left_join(x = .,
            y = conditions[select_variables],
            by = join_variables) %>%
  test_tidying()

# Check these fuzzy matches by hand
final_fuzzy <- filter(tibble::rownames_to_column(final_test_raw, "row"),
                      !hard_match & fuzzy_match) %>%
   select(row, subject, cue, target, response)

# These are determined by manual inspection
final_test_raw[final_test_raw$subject == 21 & final_test_raw$cue == "comedy",
               'fuzzy_match'] <- FALSE

## Combine practice and final tests into one data frame
tests_raw <- bind_rows(`1`=test_practice_raw, `2`=final_test_raw,
                       .id = "test") %>%
  rename(correct = fuzzy_match) %>%
  mutate(logRT = log(RT),
         test = as.numeric(test)) %>%
  select(subject, group, test, list, trial, practice, practice_cue_type, decided, recalled,
         correct, RT, logRT, pre_typing_lag:post_typing_lag)

# Remove trials where a remember/don't remember decision was not reached, and trial timed out.
tests_raw <- filter(tests_raw, decided)

rm(tp_fuzzy, final_fuzzy, join_variables, select_variables)
```
